@{
    ViewBag.Title = "Thống kê Doanh thu";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var chartData = ViewBag.ChartData as List<dynamic>;
}

<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lọc doanh thu</h2>
    @using (Html.BeginForm("DoanhThu", "AdminController_65130449", FormMethod.Get))
    {
        <div class="flex space-x-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Năm</label>
                <select name="year" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    @foreach (int y in ViewBag.Years)
                    {
                        <option value="@y" @(y == ViewBag.SelectedYear ? "selected" : "")>@y</option>
                    }
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tháng (tùy chọn)</label>
                <select name="month" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="">Tất cả các tháng</option>
                    @foreach (int m in ViewBag.Months)
                    {
                        <option value="@m" @(ViewBag.SelectedMonth == m ? "selected" : "")>Tháng @m</option>
                    }
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white px-6 py-2 rounded-lg font-medium shadow-md shadow-emerald-200/70">
                    <i class="fas fa-filter mr-2"></i>Lọc
                </button>
            </div>
        </div>
    }
</div>

<!-- Tổng doanh thu -->
<div class="bg-gradient-to-r from-sky-500 to-emerald-600 rounded-lg shadow p-8 mb-6 text-white">
    <div class="text-center">
        <p class="text-lg mb-2">Tổng doanh thu</p>
        <p class="text-4xl font-bold">@String.Format("{0:N0}", ViewBag.TongDoanhThu)₫</p>
        <p class="text-sm mt-2 opacity-90">
            @if (ViewBag.SelectedMonth != null)
            {
                <span>Tháng @ViewBag.SelectedMonth/@ViewBag.SelectedYear</span>
            }
            else
            {
                <span>Năm @ViewBag.SelectedYear</span>
            }
        </p>
    </div>
</div>

<!-- Biểu đồ -->
<div class="bg-white rounded-lg shadow p-6">
    <h3 class="text-xl font-bold text-gray-800 mb-4">Biểu đồ doanh thu</h3>
    <canvas id="revenueChart" height="100"></canvas>
</div>

@section scripts{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript">
        var ctx = document.getElementById('revenueChart').getContext('2d');
        var chartData = @Html.Raw(Json.Encode(chartData));
        var selectedMonth = @(ViewBag.SelectedMonth != null ? ViewBag.SelectedMonth.ToString() : "null");
        
        var labels = [];
        var data = [];
        
        if (selectedMonth != null) {
            // Dữ liệu theo ngày
            for (var i = 0; i < chartData.length; i++) {
                labels.push('Ngày ' + chartData[i].day);
                data.push(chartData[i].revenue);
            }
        } else {
            // Dữ liệu theo tháng
            var monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6', 
                             'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
            for (var i = 0; i < chartData.length; i++) {
                labels.push(monthNames[chartData[i].month - 1]);
                data.push(chartData[i].revenue);
            }
        }
        
        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu (₫)',
                    data: data,
                    backgroundColor: 'rgba(14, 165, 233, 0.5)',
                    borderColor: 'rgba(14, 165, 233, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('vi-VN') + '₫';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Doanh thu: ' + context.parsed.y.toLocaleString('vi-VN') + '₫';
                            }
                        }
                    }
                }
            }
        });
    </script>
}
